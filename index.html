<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParaMapz - Paranormal Locations</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
    /* Custom Leaflet control styling */
    .leaflet-control-zoom {
        border: 2px solid #444 !important;
        background: rgba(0, 0, 0, 0.9) !important;
        box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3) !important;
    }

    .leaflet-control-zoom a {
    background-color: rgba(42, 42, 42, 0.95) !important;
    color: #ff6b35 !important;
    border-bottom: 1px solid #444 !important;
    }

    .leaflet-control-zoom a:hover {
    background-color: rgba(255, 107, 53, 0.2) !important;
    color: #ff8c42 !important;
    }

    .leaflet-bar {
    border: none !important;
    }

    .leaflet-control-attribution {
    background: rgba(0, 0, 0, 0.8) !important;
    color: #ccc !important;
    }

    .leaflet-control-attribution a {
    color: #ff6b35 !important;
    }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
 
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a0a0a 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }
 
        .header {
            background: linear-gradient(135deg, #2c1810, #4a2c17);
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 20px rgba(255, 107, 53, 0.3);
        }
 
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            text-align: center;
        }
 
        .header-logo {
            max-height: 80px;
            max-width: 200px;
            height: auto;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.7));
            flex-shrink: 0;
        }
 
        .header-text {
            text-align: center;
        }
 
        .header h1 {
            font-size: 2.5em;
            color: #ff6b35;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            margin-bottom: 10px;
        }
 
        .header p {
            color: #cccccc;
            font-size: 1.1em;
        }
 
        @media (max-width: 768px) {
            .header-content {
                 gap: 15px;
             }
            
             .header-logo {
                max-height: 60px;
            }
        }
 
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
 
        .map-controls {
            background: rgba(42, 42, 42, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
 
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
 
        .control-group label {
            color: #ff6b35;
            font-size: 0.9em;
            font-weight: bold;
        }
 
        select, input {
            padding: 8px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: white;
            font-size: 14px;
        }
 
        .generate-btn {
            background: linear-gradient(135deg, #ff6b35, #e55a2e);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-left: auto;
        }
 
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }
 
        .map-container {
            background: rgba(42, 42, 42, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
 
        #map {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            border: 2px solid #444;
            position: relative;
            z-index: 1;
            background-color: #1a1a1a;
        }
 
        .leaflet-container {
            background-color: #1a1a1a !important;
        }
 
        /* Custom marker styles */
        .ed-marker {
            background: radial-gradient(circle, #ff6b35, #cc4a1a);
            border: 2px solid #ff8c42;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.7);
            animation: pulse 2s infinite;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        
        .ed-marker:hover,
        .ed-marker.selected {
            opacity: 0.4;
        }
 
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0); }
        }
 
/* Custom popup styles */
        .leaflet-popup-content-wrapper {
            background: rgba(0, 0, 0, 0.95) !important;
            border: 2px solid #ff6b35 !important;
            border-radius: 10px !important;
            color: #fff !important;
        }
 
        .leaflet-popup-content {
            color: #fff !important;
            margin: 15px !important;
        }
 
        .leaflet-popup-content h3 {
            color: #ff6b35 !important;
            margin-bottom: 8px !important;
            font-size: 1.1em !important;
        }
 
        .leaflet-popup-content p {
            color: #ccc !important;
            font-size: 0.9em !important;
            line-height: 1.4 !important;
        }
 
        .leaflet-popup-tip {
            background: rgba(0, 0, 0, 0.95) !important;
            border: 2px solid #ff6b35 !important;
        }
 
        .leaflet-popup-close-button {
            color: #ff6b35 !important;
            font-size: 18px !important;
            font-weight: bold !important;
        }
 
        .locations-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
            align-items: stretch;
        }
 
        .location-card {
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            border: 1px solid #444;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
 
        .location-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b35, #ff8c42, #ff6b35);
        }
 
        .location-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.2);
            border-color: #ff6b35;
        }
 
        .location-title {
            color: #ff6b35;
            font-size: 1.3em;
            margin-bottom: 10px;
            font-weight: bold;
        }
 
        .location-type {
            display: inline-block;
            background: rgba(255, 107, 53, 0.2);
            color: #ff6b35;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-bottom: 15px;
            border: 1px solid #ff6b35;
        }
 
        .location-story {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 15px;
        }
 
        .location-features {
            border-top: 1px solid #333;
            padding-top: 15px;
        }
 
        .location-features h4 {
            color: #ff6b35;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
 
        .features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
 
        .feature-tag {
            background: rgba(255, 107, 53, 0.1);
            color: #ff6b35;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }
 
        .loading {
            text-align: center;
            color: #ff6b35;
            font-size: 1.2em;
            padding: 40px;
        }
 
        .coordinates {
            color: #aaa;
            font-size: 0.8em;
            margin-bottom: 10px;
        }
 
        .activity-high { border-left: 5px solid #ff4444; }
        .activity-moderate { border-left: 5px solid #ffaa44; }
        .activity-low { border-left: 5px solid #44ff44; }
 
        .statistics {
            background: rgba(42, 42, 42, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
 
        .stat-item {
            color: #ff6b35;
        }
 
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
        }

        .legend {
            background: rgba(42, 42, 42, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .legend-items {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ccc;
            font-size: 0.9em;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .activity-high-legend {
            background: #ff4444;
        }

        .activity-moderate-legend {
            background: #ffaa44;
        }

        .activity-low-legend {
            background: #44ff44;
        }
 
        @media (max-width: 768px) {
            .map-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .generate-btn {
                margin-left: 0;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .locations-list {
                grid-template-columns: 1fr;
            }
 
            .statistics {
                flex-direction: column;
                gap: 10px;
            }

            .legend-items {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .legend-item {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
 
    <div class="container">
        <div class="statistics">
            <div class="stat-item">
                <div class="stat-number" id="totalLocations">20</div>
                <div>Total Locations</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="highActivity">4</div>
                <div>High Activity</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="displayedCount">0</div>
                <div>Currently Displayed</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="bookmarkCount">0</div>
                <div>Saved Locations</div>
            </div>
        </div>

        <div class="legend">
            <h3 style="color: #ff6b35; margin-bottom: 15px; text-align: center;">Activity Level Legend</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color activity-low-legend"></div>
                    <span>Low Activity - Occasional phenomena</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color activity-moderate-legend"></div>
                    <span>Moderate Activity - Regular phenomena</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color activity-high-legend"></div>
                    <span>High Activity - Frequent encounters</span>
                </div>
            </div>
        </div>
 
        <div class="map-controls">
            <div class="control-group">
                <label>State:</label>
                <select id="stateFilter">
                    <option value="" selected>All States</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="DC">District of Columbia</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NB">Nebraska</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="PR">Puerto Rico</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                </select>
            </div>
 
            <div class="control-group">
                <label>Location Type:</label>
                <select id="locationType">
                    <option value="">All Types</option>
                    <option value="Cemetery">Cemeteries</option>
                    <option value="Church">Churches</option>
                    <option value="College">Colleges</option>
                    <option value="Ghost Town">Ghost Towns</option>
                    <option value="Historic House">Historic Houses</option>
                    <option value="Hotel">Hotels</option>
                    <option value="Industrial Site">Industrial Sites</option>
                    <option value="Military Site">Military Sites</option>
                    <option value="Mining">Mining Sites</option>
                    <option value="Prison">Prisons</option>
                    <option value="Restaurant">Restaurants</option>
                    <option value="Saloon">Saloons</option>
                    <option value="Terrain">Terrain</option>                    
                    <option value="Theater">Theaters</option>
                </select>
            </div>
 
            <div class="control-group">
                <label>Activity Level:</label>
                <select id="activityLevel">
                    <option value="">All Levels</option>
                    <option value="low">Low Activity</option>
                    <option value="moderate">Moderate Activity</option>
                    <option value="high">High Activity</option>
                </select>
            </div>
 
            <div class="control-group">
                <label>Sort By:</label>
                <select id="sortOrder">
                    <option value="alphabetical">Alphabetical (A-Z)</option>
                    <option value="alphabetical-desc">Alphabetical (Z-A)</option>
                    <option value="activity">Activity Level</option>
                    <option value="year">Year Established</option>
                    <option value="type">Location Type</option>
                    <option value="city">City Name</option>
                </select>
            </div>

            <div class="control-group" style="display: flex; flex-direction: row; align-items: center; gap: 8px;">
                <input type="checkbox" id="bookmarkFilter" onchange="showBookmarkedOnly()" style="accent-color: #ff6b35; width: 18px; height: 18px; cursor: pointer;">
                <label for="bookmarkFilter" style="cursor: pointer;">Show Saved Only</label>
            </div>
 
            <button class="generate-btn" onclick="filterAndDisplayLocations()">
                Apply Filters
            </button>
        </div>
 
        <div class="map-container">
            <div id="map"></div>
        </div>
 
        <div id="locationsList" class="locations-list">
            <!-- Generated locations will appear here -->
        </div>
    </div>
 
    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // Initialize the map - Center on US with proper bounds
        let map = L.map('map', {
            center: [39.8283, -98.5795],
            zoom: 4,
            minZoom: 3,
            maxZoom: 18,
            worldCopyJump: true
        });

        // Primary tile layer - CartoDB Dark Matter
        const primaryTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        });

        // Fallback tile layer - OpenStreetMap
        const fallbackTiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });

        // Secondary fallback - Different CartoDB endpoint
        const secondaryTiles = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        });

        // Try to add primary tiles first
        let currentTileLayer = primaryTiles;
        currentTileLayer.addTo(map);

        // Enhanced error handling for tile loading
        let tileErrorCount = 0;
        map.on('tileerror', function(error) {
            console.log('Tile loading error:', error);
            tileErrorCount++;
            
            // If we get multiple tile errors, switch to fallback
            if (tileErrorCount > 3) {
                console.log('Switching to fallback tiles...');
                map.removeLayer(currentTileLayer);
                
                // Try secondary tiles first, then fallback to OSM
                if (currentTileLayer === primaryTiles) {
                    currentTileLayer = secondaryTiles;
                    currentTileLayer.addTo(map);
                } else if (currentTileLayer === secondaryTiles) {
                    currentTileLayer = fallbackTiles;
                    currentTileLayer.addTo(map);
                }
                
                tileErrorCount = 0; // Reset counter
            }
        });

        // Force refresh tiles if still gray after 5 seconds
        setTimeout(() => {
            if (tileErrorCount > 0) {
                console.log('Force switching to OpenStreetMap tiles...');
                map.removeLayer(currentTileLayer);
                currentTileLayer = fallbackTiles;
                currentTileLayer.addTo(map);
            }
        }, 5000);
 
        // Store markers for clearing
        let markersGroup = L.layerGroup().addTo(map);
 
        // Haunted locations database
let hauntedLocations = [];

async function loadLocations() {
    try {
        document.getElementById('totalLocations').textContent = 'Loading...';
        
        const response = await fetch('https://script.google.com/macros/s/AKfycbxhI0ehH43dAegX3tYKSN9A92RshNWKLHkaIBA0dUFoJ3TCfXE0DsNQlojoTQNh5QdbHg/exec');
        hauntedLocations = await response.json();
        
        console.log(`Loaded ${hauntedLocations.length} locations from Google Sheets`);
        
        // Now initialize the app with the loaded data
        initializeApp();
        
    } catch (error) {
        console.error('Error loading locations:', error);
        document.getElementById('totalLocations').textContent = 'Error';
    }
}
		
let currentDisplayedLocations = [];

        // ==========================================
        // BOOKMARK FUNCTIONALITY - LOCAL STORAGE
        // ==========================================
        
        // Initialize bookmarks from local storage
        let bookmarkedLocations = JSON.parse(localStorage.getItem('paramapz_bookmarks')) || [];

        // Save bookmarks to local storage
        function saveBookmarksToStorage() {
            localStorage.setItem('paramapz_bookmarks', JSON.stringify(bookmarkedLocations));
        }

        // Check if a location is bookmarked
        function isBookmarked(locationId) {
            return bookmarkedLocations.includes(locationId);
        }

        // Toggle bookmark status
        function toggleBookmark(locationId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            if (isBookmarked(locationId)) {
                bookmarkedLocations = bookmarkedLocations.filter(id => id !== locationId);
            } else {
                bookmarkedLocations.push(locationId);
            }
            
            saveBookmarksToStorage();
            updateBookmarkUI(locationId);
            updateBookmarkCount();
        }

        // Update bookmark button UI for a specific location
        function updateBookmarkUI(locationId) {
            const buttons = document.querySelectorAll(`[data-bookmark-id="${locationId}"]`);
            buttons.forEach(btn => {
                if (isBookmarked(locationId)) {
                    btn.classList.add('bookmarked');
                    btn.innerHTML = getBookmarkIcon(true) + ' Saved';
                    btn.title = 'Remove from Saved';
                } else {
                    btn.classList.remove('bookmarked');
                    btn.innerHTML = getBookmarkIcon(false) + ' Save';
                    btn.title = 'Save Location';
                }
            });
        }

        // Get bookmark icon SVG (heart)
        function getBookmarkIcon(filled) {
            if (filled) {
                return `<svg viewBox="0 0 24 24" width="14" height="14" style="width: 14px !important; height: 14px !important; min-width: 14px; max-width: 14px; fill: currentColor;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
            } else {
                return `<svg viewBox="0 0 24 24" width="14" height="14" style="width: 14px !important; height: 14px !important; min-width: 14px; max-width: 14px; fill: currentColor;"><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"/></svg>`;
            }
        }

        // Update bookmark count in statistics
        function updateBookmarkCount() {
            const countElement = document.getElementById('bookmarkCount');
            if (countElement) {
                countElement.textContent = bookmarkedLocations.length;
            }
        }

        // Filter to show only bookmarked locations
        function showBookmarkedOnly() {
            const bookmarkFilter = document.getElementById('bookmarkFilter');
            if (bookmarkFilter && bookmarkFilter.checked) {
                const bookmarkedLocs = hauntedLocations.filter(loc => isBookmarked(loc.id));
                displayLocationsOnMap(bookmarkedLocs);
                displayLocationsList(bookmarkedLocs);
                updateDisplayedCount(bookmarkedLocs.length);
                if (bookmarkedLocs.length > 0) {
                    centerMapOnLocations(bookmarkedLocs);
                }
            } else {
                filterAndDisplayLocations();
            }
        }

        // Generate bookmark button HTML for popups (inline styles)
        function getPopupBookmarkButton(locationId) {
            const bookmarked = isBookmarked(locationId);
            return `
                <button 
                    onclick="toggleBookmark('${locationId}', event)" 
                    data-bookmark-id="${locationId}"
                    title="${bookmarked ? 'Remove from Saved' : 'Save Location'}"
                    style="display: inline-flex; align-items: center; gap: 4px; background: ${bookmarked ? 'rgba(255, 107, 53, 0.4)' : 'rgba(255, 107, 53, 0.2)'}; color: #ff8c42; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.75em; border: 1px solid #ff6b35; cursor: pointer;"
                    class="${bookmarked ? 'bookmarked' : ''}"
                >
                    ${getBookmarkIcon(bookmarked)} ${bookmarked ? 'Saved' : 'Save'}
                </button>
            `;
        }

        // Generate bookmark button HTML for cards (inline styles)
        function getCardBookmarkButton(locationId) {
            const bookmarked = isBookmarked(locationId);
            return `
                <button 
                    onclick="toggleBookmark('${locationId}', event)" 
                    data-bookmark-id="${locationId}"
                    title="${bookmarked ? 'Remove from Saved' : 'Save Location'}"
                    style="display: inline-flex; align-items: center; gap: 4px; background: ${bookmarked ? 'rgba(255, 107, 53, 0.4)' : 'rgba(255, 107, 53, 0.2)'}; color: #ff8c42; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.75em; border: 1px solid #ff6b35; cursor: pointer;"
                    class="${bookmarked ? 'bookmarked' : ''}"
                >
                    ${getBookmarkIcon(bookmarked)} ${bookmarked ? 'Saved' : 'Save'}
                </button>
            `;
        }

        // ==========================================
        // MAIN APPLICATION FUNCTIONS
        // ==========================================
 
        // Initialize the application
        function initializeApp() {
            updateStatistics();
            updateBookmarkCount();
            displayAllLocations();
        }
 
        // Filter and display locations based on current selections
        function filterAndDisplayLocations() {
            // Uncheck bookmark filter when applying other filters
            const bookmarkFilter = document.getElementById('bookmarkFilter');
            if (bookmarkFilter) {
                bookmarkFilter.checked = false;
            }

            const stateFilter = document.getElementById('stateFilter').value;
            const typeFilter = document.getElementById('locationType').value;
            const activityFilter = document.getElementById('activityLevel').value;
            const sortOrder = document.getElementById('sortOrder').value;
 
            // Filter locations
            let filteredLocations = hauntedLocations.filter(location => {
                const stateMatch = !stateFilter || location.state === stateFilter;
                const typeMatch = !typeFilter || location.type === typeFilter;
                const activityMatch = !activityFilter || location.activityLevel === activityFilter;
                return stateMatch && typeMatch && activityMatch;
            });
 
            // Sort locations based on selected option
            filteredLocations = sortLocations(filteredLocations, sortOrder);
 
            currentDisplayedLocations = filteredLocations;
            
            // Show loading
            document.getElementById('locationsList').innerHTML = '<div class="loading">Filtering haunted locations...</div>';
            
            setTimeout(() => {
                displayLocationsOnMap(filteredLocations);
                displayLocationsList(filteredLocations);
                updateDisplayedCount(filteredLocations.length);
                
                // Center map on filtered results
                if (filteredLocations.length > 0) {
                    centerMapOnLocations(filteredLocations);
                }
            }, 1000);
        }
 
        // Sort locations based on selected criteria
        function sortLocations(locations, sortBy) {
            const sortedLocations = [...locations];
            
            switch(sortBy) {
                case 'alphabetical':
                    return sortedLocations.sort((a, b) => a.name.localeCompare(b.name));
                case 'alphabetical-desc':
                    return sortedLocations.sort((a, b) => b.name.localeCompare(a.name));
                case 'activity':
                    const activityOrder = { 'high': 3, 'moderate': 2, 'low': 1 };
                    return sortedLocations.sort((a, b) => {
                        const aOrder = activityOrder[a.activityLevel];
                        const bOrder = activityOrder[b.activityLevel];
                        return bOrder - aOrder;
                    });
                case 'year':
                    return sortedLocations.sort((a, b) => a.yearEstablished - b.yearEstablished);
                case 'type':
                    return sortedLocations.sort((a, b) => a.type.localeCompare(b.type));
                case 'city':
                    return sortedLocations.sort((a, b) => a.city.localeCompare(b.city));
                default:
                    return sortedLocations.sort((a, b) => a.name.localeCompare(b.name));
            }
        }
 
        // Display all locations initially
        function displayAllLocations() {
            const sortOrder = document.getElementById('sortOrder')?.value || 'alphabetical';
            const sortedLocations = sortLocations(hauntedLocations, sortOrder);
            currentDisplayedLocations = sortedLocations;
            displayLocationsOnMap(sortedLocations);
            displayLocationsList(sortedLocations);
            updateDisplayedCount(sortedLocations.length);
            centerMapOnLocations(sortedLocations);
        }
 
        // Center map on a set of locations
        function centerMapOnLocations(locations) {
            if (locations.length === 0) return;
            
            if (locations.length === 1) {
                map.setView(locations[0].coordinates, 10);
            } else {
                const group = new L.featureGroup(locations.map(loc => 
                    L.marker(loc.coordinates)
                ));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Generate Google Maps directions URL
        function getDirectionsUrl(coordinates) {
            return `https://www.google.com/maps/dir/?api=1&destination=${coordinates[0]},${coordinates[1]}`;
        }
 
        // Display locations on map
        function displayLocationsOnMap(locations) {
            markersGroup.clearLayers();
 
            locations.forEach(location => {
                const hauntedIcon = L.divIcon({
                    className: 'haunted-marker',
                    html: 'üìç',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
 
                const marker = L.marker(location.coordinates, {
                    icon: hauntedIcon
                }).addTo(markersGroup);
 
                const popupContent = `
                    <div style="max-width: 300px;">
                        <h3 style="margin-bottom: 10px;">${location.name}</h3>
                        ${location.imageUrl ? `
                            <img src="${location.imageUrl}" 
                                 alt="${location.name}" 
                                 style="width: 100%; max-width: 280px; height: 180px; object-fit: cover; border-radius: 5px; margin-bottom: 10px;"
                                 onerror="this.style.display='none'">
                        ` : ''}
                        <p style="margin-bottom: 5px;"><strong>Location:</strong> ${location.city}, ${location.state}</p>
                        <p style="margin-bottom: 5px;"><strong>Type:</strong> ${location.type}</p>
                        <p style="margin-bottom: 5px;"><strong>Established:</strong> ${location.yearEstablished}</p>
                        <p style="margin-bottom: 10px;"><strong>Activity Level:</strong> <span style="color: ${location.activityLevel === 'high' ? '#ff4444' : location.activityLevel === 'moderate' ? '#ffaa44' : '#44ff44'};">${location.activityLevel.toUpperCase()}</span></p>
                        <div style="margin-bottom: 10px;">
                            <strong>Story:</strong>
                            <p style="margin-top: 5px; line-height: 1.4; font-size: 0.9em;">${location.story}</p>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Reported Phenomena:</strong>
                            <div style="margin-top: 5px; display: flex; flex-wrap: wrap; gap: 4px;">
                                ${location.features.map(feature => `<span style="background: rgba(255, 107, 53, 0.2); color: #ff6b35; padding: 2px 6px; border-radius: 8px; font-size: 0.8em; border: 1px solid rgba(255, 107, 53, 0.3);">${feature}</span>`).join('')}
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                            <a href="${getDirectionsUrl(location.coordinates)}" 
                               target="_blank" 
                               rel="noopener noreferrer" 
                               style="display: inline-flex; align-items: center; gap: 4px; background: rgba(255, 107, 53, 0.2); color: #ff8c42; padding: 4px 10px; border-radius: 12px; text-decoration: none; font-weight: bold; font-size: 0.75em; border: 1px solid #ff6b35;">
                                <svg viewBox="0 0 24 24" width="12" height="12" style="width: 12px !important; height: 12px !important; min-width: 12px; max-width: 12px; fill: currentColor;"><path d="M21.71 11.29l-9-9a1 1 0 0 0-1.42 0l-9 9a1 1 0 0 0 0 1.42l9 9a1 1 0 0 0 1.42 0l9-9a1 1 0 0 0 0-1.42zM14 14.5V12h-4v3H8v-4a1 1 0 0 1 1-1h5V7.5l3.5 3.5-3.5 3.5z"/></svg>
                                Directions
                            </a>
                            ${getPopupBookmarkButton(location.id)}
                        </div>
                    </div>
                `;
 
                marker.bindPopup(popupContent, {
                    maxWidth: 320,
                    maxHeight: 600,
                    className: 'haunted-popup'
                });

                marker.on('click', () => {
                    marker.openPopup();
                });
            });
        }
 
        // Display locations list
        function displayLocationsList(locations) {
            const listContainer = document.getElementById('locationsList');
            
            listContainer.innerHTML = locations.map(location => `
                <div class="location-card activity-${location.activityLevel}" data-id="${location.id}" style="display: flex; flex-direction: column; height: 100%;">
                    ${location.imageUrl ? `
                        <div class="location-image">
                            <img src="${location.imageUrl}" 
                                 alt="${location.name}" 
                                 onerror="this.style.display='none'"
                                 loading="lazy">
                        </div>
                    ` : ''}
                    <div class="location-title">${location.name}</div>
                    <div class="coordinates">${location.city}, ${location.state}</div>
                    <div class="location-type">${location.type}</div>
                    <div class="location-story">${location.story}</div>
                    <div class="location-features">
                        <h4>Reported Phenomena:</h4>
                        <div class="features-list">
                            ${location.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
                        </div>
                    </div>
                    ${location.imageSource ? `<div class="image-source-badge">Source: ${location.imageSource}</div>` : ''}
                    <div style="flex: 1;"></div>
                    <div style="text-align: center; padding-top: 15px; margin-top: auto; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                        <a href="${getDirectionsUrl(location.coordinates)}" 
                           target="_blank" 
                           rel="noopener noreferrer" 
                           style="display: inline-flex; align-items: center; gap: 4px; background: rgba(255, 107, 53, 0.2); color: #ff8c42; padding: 4px 10px; border-radius: 12px; text-decoration: none; font-weight: bold; font-size: 0.75em; border: 1px solid #ff6b35;">
                            <svg viewBox="0 0 24 24" width="12" height="12" style="width: 12px !important; height: 12px !important; min-width: 12px; max-width: 12px; fill: currentColor;"><path d="M21.71 11.29l-9-9a1 1 0 0 0-1.42 0l-9 9a1 1 0 0 0 0 1.42l9 9a1 1 0 0 0 1.42 0l9-9a1 1 0 0 0 0-1.42zM14 14.5V12h-4v3H8v-4a1 1 0 0 1 1-1h5V7.5l3.5 3.5-3.5 3.5z"/></svg>
                            Directions
                        </a>
                        ${getCardBookmarkButton(location.id)}
                    </div>
                </div>
            `).join('');
        }
 
        // Update statistics
        function updateStatistics() {
            const totalCount = hauntedLocations.length;
            const highActivityCount = hauntedLocations.filter(loc => loc.activityLevel === 'high').length;
            
            document.getElementById('totalLocations').textContent = totalCount;
            document.getElementById('highActivity').textContent = highActivityCount;
        }
 
        // Update displayed count
        function updateDisplayedCount(count) {
            document.getElementById('displayedCount').textContent = count;
        }
 
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadLocations();
        });
 
        // Add event listeners for filtering
        document.getElementById('stateFilter').addEventListener('change', filterAndDisplayLocations);
        document.getElementById('locationType').addEventListener('change', filterAndDisplayLocations);
        document.getElementById('activityLevel').addEventListener('change', filterAndDisplayLocations);
        document.getElementById('sortOrder').addEventListener('change', filterAndDisplayLocations);
    </script>
</body>
</html>
